version: '3'

# Benchmark Tasks
# Handles performance benchmarking

vars:
  PHP_82: data-helpers-php82
  PHP_83: data-helpers-php83
  PHP_84: data-helpers-php84
  DEFAULT_PHP: "{{.PHP_84}}"
  OUTPUT_HELPER: ./scripts/task-output.sh

tasks:
  run:
    desc: Run benchmarks (use PHP=8.2|8.3|8.4)
    cmds:
      - |
        source {{.OUTPUT_HELPER}}
        task_run "Running Benchmarks" \
          docker exec {{.PHP | default .DEFAULT_PHP}} vendor/bin/phpbench run --report=table

  dto:
    desc: Run Dto benchmarks (Traditional vs SimpleDto) [DEPRECATED - use bench:comprehensive]
    cmds:
      - |
        source {{.OUTPUT_HELPER}}
        task_run "Running Dto Benchmarks" \
          docker exec {{.PHP | default .DEFAULT_PHP}} php scripts/dto-benchmark.php

  isolated:
    desc: Run comprehensive benchmarks and update documentation (isolated, use PHP=8.2|8.3|8.4)
    cmds:
      - |
        source {{.OUTPUT_HELPER}}
        task_header "Running Comprehensive Benchmarks (Isolated)"
        ./scripts/benchmark-isolated.sh --php {{.PHP | default "8.4"}}
        EXIT_CODE=$?
        if [ $EXIT_CODE -eq 0 ]; then
          task_success "Benchmarks completed and documentation updated"
        else
          task_error "Benchmarks failed"
        fi
        task_footer
        exit $EXIT_CODE

  readme:
    desc: Run comprehensive benchmarks directly (no isolation, use PHP=8.2|8.3|8.4)
    aliases: [direct]
    cmds:
      - |
        source {{.OUTPUT_HELPER}}
        task_header "Running Comprehensive Benchmarks (Direct)"
        docker exec {{.PHP | default .DEFAULT_PHP}} php scripts/comprehensive-benchmark.php --readme
        EXIT_CODE=$?
        if [ $EXIT_CODE -eq 0 ]; then
          task_success "Benchmarks completed and documentation updated"
        else
          task_error "Benchmarks failed"
        fi
        task_footer
        exit $EXIT_CODE

